/** 
 * reLift-HTML v0.0.5
 * Copyright 2019 Mardix mcx2082@gmail.com
 * License: MIT
 * https://github.com/mardix/relift-html
 * Build date: 5/5/2019, 3:22:49 AM
 * 
 */
const t=(t,e)=>t&&"function"==typeof t[e],e=t=>"string"==typeof t?document.querySelector(t):t,n=t=>(new DOMParser).parseFromString(t,"text/html").body,r=(t,e)=>n=>n[t]=e({...n}),o=t=>Object.freeze(Array.from(t.attributes).map(t=>({[t.name]:t.value})).reduce((t,e)=>({...t,...e}),{})),i=(t=7)=>Math.random().toString(36).toLowerCase().substring(t),s=(t,e)=>{let n=!1,r=!1;const o=new WeakMap,i=()=>{e()},s={get(t,e,n){if("___target___"===e)return t;const r=Reflect.get(t,e,n);if((t=>null===t||!["function","object"].includes(typeof t))(r)||"constructor"===e)return r;const i=((t,e)=>{let n=o.get(t);if(n)return n;n=new Map,o.set(t,n);let r=n.get(e);return r||(r=Reflect.getOwnPropertyDescriptor(t,e),n.set(e,r)),r})(t,e);if(i&&!i.configurable){if(i.set&&!i.get)return;if(!1===i.writable)return r}return new Proxy(r,s)},set(t,e,n,r){n&&void 0!==n.___target___&&(n=n.___target___);const o=Reflect.get(t,e,r),s=Reflect.set(t,e,n);return o!==n&&i(),s},defineProperty(t,e,n){const r=Reflect.defineProperty(t,e,n);return i(),r},deleteProperty(t,e){const n=Reflect.deleteProperty(t,e);return i(),n},apply(t,o,i){if(!n){n=!0;const s=Reflect.apply(t,o,i);return r&&e(),n=r=!1,s}return Reflect.apply(t,o,i)}};return new Proxy(t,s)},a=(t,e)=>Array.from(t.childNodes).filter(t=>e(t)).map(t=>({[e(t)]:t})).reduce((t,e)=>({...t,...e}),{});const l=[];for(const t in document){const e=null===document[t]||"function"==typeof document[t];t.startsWith("on")&&e&&l.push(t.substring(2))}const c="r-events-list",u=t=>`r-on-${t}`;const f={$for:function(t,e,n){const r=/(.*)\s+(in)\s+(.*)$/.exec(e);if(4===r.length){const e=r[1].replace("(","").replace(")",""),o=r[3];y(t,`\${${o}.map(function(${e}) { return \``,"`}.bind(this)).join('')}"),g(t,n)}},$if:function(t,e,n){g(t,n),b(t,`\${${e} ? `);const r=t.nextElementSibling;r&&m(r,"else")?(y(t,"`","`"),g(r,"else"),y(r,":`","`}")):y(t,"`","`:``}")},$value:function(t,e,n){return}};const d=t=>`r-${t}`,m=(t,e)=>t.hasAttribute(d(e)),p=(t,e)=>t.getAttribute(d(e)),g=(t,e)=>t.removeAttribute(d(e)),h=(t,e)=>t.querySelectorAll(`[${d(e)}]`),b=(t,e)=>t.insertAdjacentText("beforebegin",e),y=(t,e,n)=>{b(t,e),((t,e)=>t.insertAdjacentText("afterend",e))(t,n)};const $=["data","el","templateString","template","created","updated","removed","$store","$attrs","tagName","type"],A=t=>new Error(`reLift-HTML Error: ${t}`),N=t=>e=>(e.$store=t.getState(),t.subscribe(n=>e.$store=t.getState())),S=t=>{const e=n(t);!function(t,e={}){const n={...e,...f};for(const e in n){const r=e.replace("$","");for(const o of h(t,r))if(m(o,r)){const t=p(o,r);n[e](o,t,r)}}}(e),function(t){for(const e of t.querySelectorAll("[\\@call]")){const t=e.getAttribute("@call");e.removeAttribute("@call");let n=["click"];e instanceof HTMLInputElement||e instanceof HTMLTextAreaElement?n=["input","paste"]:e instanceof HTMLSelectElement?n=["change"]:e instanceof HTMLFormElement?n=["submit"]:e instanceof HTMLAnchorElement&&e.setAttribute("href","javascript:void(0);");let r=(e.getAttribute(c)||"").split(",").filter(t=>t);r=r.concat(n),e.setAttribute(c,r.join(","));for(const r of n)e.setAttribute(u(r),t)}for(const e of l)for(const n of t.querySelectorAll(`[\\@${e}]`)){const t=(n.getAttribute(c)||"").split(",").filter(t=>t);t.push(e),n.setAttribute(c,t.join(",")),n.setAttribute(u(e),n.getAttribute(`@${e}`)),n.removeAttribute(`@${e}`),n instanceof HTMLAnchorElement&&n.setAttribute("href","javascript:void(0);")}}(e);const r=e.outerHTML,i=(t=>e=>new Function(`return \`${t}\``).call(e))(r);return{html:r,render:(t,e)=>{const r=n(i(e));return!t.isEqualNode(r)&&function t(e,n,r={}){if(r={key:t=>t.id,...r},"string"==typeof n){const t=n;(n=document.createElement(e.tagName)).innerHTML=t}const i=a(e,r.key);let s;for(s=0;n.firstChild;s++){const a=n.removeChild(n.firstChild);if(s>=e.childNodes.length){e.appendChild(a);continue}let l=e.childNodes[s];const c=r.key(a);if(r.key(l)||c){const t=c&&c in i?i[c]:a;t!==l&&(l=e.insertBefore(t,l))}if(l.nodeType!==a.nodeType||l.tagName!==a.tagName)e.replaceChild(a,l);else if([Node.TEXT_NODE,Node.COMMENT_NODE].indexOf(l.nodeType)>=0)l.textContent!==a.textContent&&(l.textContent=a.textContent);else if(l!==a){const e=o(l),n=o(a);for(const t in e)t in n||l.removeAttribute(t);for(const t in n)t in e&&e[t]===n[t]||l.setAttribute(t,n[t]);t(l,a)}}for(;e.childNodes.length>s;)e.removeChild(e.lastChild);return!0}(t,r)}}};function E(e={}){const n={type:"CE",tagName:null,data:{},templateString:null,$store:{getState:()=>{},subscribe:()=>()=>{}},created(){},updated(){},removed(){},...e},i=N(n.$store),a=S(n.templateString),l=Object.keys(n).filter(t=>!$.includes(t)).filter(e=>t(n,e)).reduce((t,e)=>({...t,[e]:n[e]}),{}),f=Object.keys(n.data).filter(e=>!t(n.data,e)).reduce((t,e)=>({...t,[e]:n.data[e]}),{}),d=Object.keys(n.data).filter(e=>t(n.data,e)).map(t=>r(t,n.data[t])),m=t=>d.forEach(e=>e(t));window.customElements.define(n.tagName.toLowerCase(),class extends HTMLElement{constructor(){super(),this.$root="SD"===n.type?this.attachShadow({mode:"open"}):this}connectedCallback(){this.state={...this.state,...f,$attr:o(this)};const t=s(this.state,()=>{m(this.state),a.render(this.$root,this.state)&&n.updated.call(this.context)});this.disconnectStore=i(t),this.$root.innerHTML=a.html,this.context={...l,$attr:this.state.$attr,el:this.$root,data:t},function(t,e){function n(t){Array.from(t.querySelectorAll(`[${c}]`)).map(t=>{(t.getAttribute(c)||"").split(",").filter(t=>t).map(n=>{t[`on${n}`]=(r=>{r.preventDefault();const o=t.getAttribute(u(n));e[o].call(e,r)})})})}const r=new MutationObserver(t=>{[...t].filter(t=>t.addedNodes.length>0).map(t=>t.target).map(t=>n(t))});r.observe(t,{attributes:!0,childList:!0,subtree:!0}),n(t)}(this.$root,this.context),m(this.state),a.render(this.$root,this.state),n.created.call(this.context)}disconnectedCallback(){n.removed.call(this.context),this.disconnectStore()}})}export default function(t={}){const n={el:null,tagName:null,type:null,templateString:null,...t};let r=null;if(n.templateString||(n.template?(r=e(n.template),n.type=n.type||"SD",n.tagName=n.tagName||r.getAttribute("tag-name"),n.templateString=r.innerHTML):n.el&&(r=e(n.el),n.type=n.type||"CE",n.tagName=n.tagName||`rel-${r.id}-${i()}`,n.templateString=r.outerHTML)),n.el&&"CE"===n.type&&(r=e(n.el),n.tagName=n.tagName||`rel-${r.id}-${i()}`,r.parentNode.replaceChild(document.createElement(n.tagName),r)),!n.templateString)throw A("missing 'templateString' option or 'el|template' are not valid elements");if(!n.tagName)throw A("missing 'tagName'");E(n)}
